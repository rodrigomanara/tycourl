{% extends 'template.html.twig' %}

{% block navigation %}
    {% include 'navigation.logged.twig' %}
{% endblock navigation %}

{% block content %}
    <!-- Home/Landing Page -->
    <div id="homePage">
        <!-- Hero Section -->
        <section class="bg-gradient-to-br from-blue-50 via-white to-orange-50 py-16 md:py-24">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Shortener Box -->
                <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
                    <div class="flex border-b border-gray-200 mb-6">
                        <button id="linkTab"
                                class="flex-1 pb-4 text-sm font-semibold text-orange-500 border-b-2 border-orange-500">
                            Short link
                        </button>
                        <button id="qrTab" class="flex-1 pb-4 text-sm font-semibold text-gray-500">
                            QR Code
                        </button>
                    </div>

                    <!-- Link Panel -->
                    <div id="linkPanel">
                        <form id="urlForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Paste long URL</label>
                                <input type="url" id="longUrl" required
                                       placeholder="https://example.com/very-long-url..."
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none text-base">
                            </div>

                            <button type="submit"
                                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                Shorten URL
                            </button>
                        </form>

                        <div id="result" class="hidden mt-6 p-5 bg-green-50 border border-green-200 rounded-lg fade-in">
                            <p class="text-sm text-gray-700 font-medium mb-3">Your shortened URL:</p>
                            <div class="flex gap-2">
                                <input type="text" id="shortUrl" readonly
                                       class="flex-1 px-4 py-2.5 bg-white border border-gray-300 rounded-lg font-mono text-sm">
                                <button id="copyBtn"
                                        class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                                    Copy
                                </button>
                            </div>
                        </div>

                    </div>

                    <!-- QR Panel -->
                    <div id="qrPanel" class="hidden">
                        <form id="qrForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Enter your QR Code
                                    destination</label>
                                <input type="url" id="qrUrl" required placeholder="https://example.com..."
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none text-base">
                            </div>

                            <button type="submit"
                                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                Create QR Code
                            </button>
                        </form>
                    </div>
                    <div id="qrResultString" class="hidden mt-6 p-5 bg-green-50 border border-green-200 rounded-lg fade-in">
                        <p class="text-sm text-gray-700 font-medium mb-3">Your shortened URL:</p>
                        <div class="flex gap-2">
                            <input type="text" id="qrShortUrl" readonly
                                   class="flex-1 px-4 py-2.5 bg-white border border-gray-300 rounded-lg font-mono text-sm">
                            <button id="copyBtn"
                                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                                Copy
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <div  style="border: 1px solid black;padding: 2px;margin: 5px;width:100%;" id="qrCodePlaceHolder"></div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        let utils = new Utils();
        utils.isLoggedOut();

        (function () {

            let linkTab = document.getElementById("linkTab");
            let qrTab = document.getElementById("qrTab");

            let linkPanel = document.getElementById("linkPanel");
            let qrPanel = document.getElementById("qrPanel");

            // Tab switching
            linkTab.addEventListener('click', () => {
                // Update tab styles
                linkTab.classList.remove('text-gray-500');
                linkTab.classList.add('text-orange-500', 'border-b-2', 'border-orange-500');

                qrTab.classList.remove('text-orange-500', 'border-b-2', 'border-orange-500');
                qrTab.classList.add('text-gray-500');

                // Toggle panels
                linkPanel.classList.remove('hidden');
                qrPanel.classList.add('hidden');
            });

            qrTab.addEventListener('click', () => {
                // Update tab styles
                qrTab.classList.remove('text-gray-500');
                qrTab.classList.add('text-orange-500', 'border-b-2', 'border-orange-500');

                linkTab.classList.remove('text-orange-500', 'border-b-2', 'border-orange-500');
                linkTab.classList.add('text-gray-500');

                // Toggle panels
                qrPanel.classList.remove('hidden');
                linkPanel.classList.add('hidden');
            });

            /**
             *
             * @param message
             * @param type
             */
            function showAlert(message, type = 'success') {
                const container = document.getElementById('alertContainer');
                const alertDiv = document.createElement('div');

                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };

                const icons = {
                    success: '✓',
                    error: '✕',
                    warning: '⚠',
                    info: 'ℹ'
                };

                alertDiv.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-80 max-w-md`;
                alertDiv.style.animation = 'slideIn 0.3s ease-out';
                alertDiv.innerHTML = `
                <span class="text-xl font-bold">${icons[type]}</span>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 text-xl font-bold">×</button>
            `;

                container.appendChild(alertDiv);

                setTimeout(() => {
                    alertDiv.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => alertDiv.remove(), 300);
                }, 5000);
            }
            /**
             *
             * @param data
             * @returns {Promise<any>}
             */
            function createUrl(data) {
                return fetch('/rest/api/hash/create', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${utils.getToken()}`,
                    },
                    method: 'POST',
                    body: JSON.stringify(data),
                }).then(res => res.json());
            }
            // URL shortener
            document.getElementById('urlForm').addEventListener('submit', (e) => {
                e.preventDefault();
                createUrl({'user_id': utils.getUserId(),'url': document.getElementById('longUrl').value,})
                    .then((response) => {
                    let responseResult = response.response;
                    if (responseResult.success === false)
                        throw responseResult.errorMessage;

                    let data = responseResult.data;

                    const shortUrlInput = document.getElementById('shortUrl');
                    const shortCode = data.hash;

                    shortUrlInput.value = `${window.location.origin}/${shortCode}`;
                    result.classList.remove('hidden');
                    urlForm.reset();

                    showAlert('Data Saved!', 'success');
                }).catch(e => {
                    showAlert(e, 'error');
                })
            });

            // URL shortener
            document.getElementById('qrForm').addEventListener('submit', (e) => {
                e.preventDefault();
                createUrl({ 'user_id': utils.getUserId(),  'url': document.getElementById('qrUrl').value, 'qr_code' : `${window.location.origin}`}
                ).then((response) => {
                    let responseResult = response.response;
                    if (responseResult.success === false)
                        throw responseResult.errorMessage;

                    let data = responseResult.data;

                    const shortUrlInput = document.getElementById('qrShortUrl');
                    shortUrlInput.value = `${window.location.origin}/${data.hash}`;

                    const qrCodePlaceHolder = document.getElementById('qrCodePlaceHolder');
                    qrCodePlaceHolder.innerHTML = `<img src='${data.qr_code}' style='margin: auto' alt='${data.hash}' />`;

                    let result = document.getElementById('qrResultString');
                    result.classList.remove('hidden');
                    document.getElementById('qrForm').reset();

                    showAlert('Data Saved!', 'success');
                }).catch(e => {
                    showAlert(e, 'error');
                })
            });
        })();
    </script>
{% endblock %}